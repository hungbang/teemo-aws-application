Standard Helm (3) chart for a teemo Spring Boot application to be deployed to EKS.

Currently spring boot 2.

Look at values.yaml for a base set of values your app should override. Many other settings can be overridden. Look at the templates for the different value names.

Installing an app

```
helm install <<app_name>> --namespace=<<namespace>> -f my-app-values.yaml teemo-aws-application
```

# Hostnames

By default, the hostname will be autogenerated based on the environment and appname.
You can override this by setting the hosts value:
```
hosts:
  - myappsubdomain.teemo.ai
```

The chart still supports the older host values as well:
```
host: myappsubdomain.teemo.ai
```

DO NOT specify host and hosts values. Use the hosts variable as the prefered var.

# Ingress

By default, ingress will be setup on the 'private' ingress. This will give you ingress via *.apps.teemo.ai.
If you want public ingress, for a public facing webapp, add the following:

```
istio:
  ingress:
    selector: "ingress: public"
```

This will setup istio to route traffic via the public loadbalancer. This should be used with cloudfront to serve your app.

# Sticky Sessions

NOTE: It is highly discouraged to use sessions, new apps should be designed to be stateless

This will setup an Istio Destination Rule for sticky sessions. It will create a cookie for your app to track the session.

```
stickySession:
  path: /test
```

# Configuring 302 redirects instead of 40X responses

Set this value to true in tour values.yaml:
```
auth:
  redirectToLogin: true
```

If you only need redirects for 1 particular app on a subdomain, set path matching like this:
```
auth:
  redirectToLogin: true
  redirectMatchPath: "/app_context_path"
```

# StatefulSet
If a StatefulSet resource is needed to deploy your app, set the following value:
```
deploymentType: "statefulset"
```
This will create a StatefulSet resource (instead of the default Deployment resource), and a headless service named ```{{appname}}-headless```.
<br/>
Your app can manage state using the POD_NAME environment variable or an additional active spring profile:<br/>
```POD_NAME``` - will be set to the appname with the ordinal suffix (appname-0 or appname-1)<br/>
```SPRING_ACTIVE_PROFILES``` - An additional spring profile will be active and will have the value of {ENV}-{POD_NAME}, ex. dev-appname-0, or prd-appname-1


# Adding Security

To enable RBAC for the app using Istio Authorization policies specify the following block in the values.yaml

```
security:
  authenticationPolicy:
    issuer: "https://dev-ssoteemo.oktapreview.com/oauth2/auss0ybpigBzir9hJ0h7"
    jwksUri: https://dev-ssoteemo.oktapreview.com/oauth2/auss0ybpigBzir9hJ0h7/v1/keys
  rules:
    - path: "/sample-jsp"
      roles: ["role1", "role2"]
    - path: "/admin"
      roles: ["role1", "role2"]
```

To enable a restriction based on the OIDC client id (recommended for latest apps) add clientid.
This should be part of the same security block above.
```
security:
  clientid: ["0oas3hrp1ueVwp8MA0h7"]
```

If your app is using the accessToken cookie and cannot use PKCE Auth Code flow
add the following to the security block. This is for JSP or Angular < 6
```
security:
  cookie: true
  filter:
    redirectURL: "https://sso.apps.apppoc.teemo.ai/sso?origin="
    cookieName: "accessToken"
``
```
# Custom Security

To provide security policies not supported above, native istio manifests can be provided under security.polices.
Note that these are not templates, so selectors and app names need to be coded into the template.
```
security:
  policies: |-
    apiVersion: security.istio.io/v1beta1
    kind: AuthorizationPolicy
    metadata:
      name: test-authorization-policy
    spec:
      selector:
        matchLabels:
          app: test
      action: ALLOW
      rules:
        to:
        - operation:
            methods: ["GET"]
    ---
    apiVersion: security.istio.io/v1beta1
    kind: AuthorizationPolicy
    metadata:
      name: name
    spec:
      selector:
        matchLabels:
          app: name
      action: DENY
      rules:
      - from:
        - source:
            principals: ["cluster.local/ns/default/sa/sleep"]
        - source:
            namespaces: ["dev"]
        to:
        - operation:
            methods: ["POST"]
        when:
        - key: request.auth.claims[iss]
          values: ["https://accounts.google.com"]
```

# Configmap mount
If a configmap needed to be mounted as application-[profile].yaml into /config directory  set the following value:
```
mountConfigmap: true
```

